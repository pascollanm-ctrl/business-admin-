<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Business Controller</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .active-status { background-color: #d1fae5; color: #059669; } /* Green */
        .expiring-status { background-color: #fef3c7; color: #d97706; } /* Yellow/Orange */
        .suspended-status { background-color: #fee2e2; color: #dc2626; } /* Red */

        /* Style for the calendar modal background */
        .calendar-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        
        /* Ensure table is responsive on smaller screens */
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            .data-table th, .data-table td {
                min-width: 120px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Toast Notification Area -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>
    
    <!-- Main Header -->
    <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 flex items-center">
            <i data-lucide="layout-grid" class="w-8 h-8 mr-3 text-indigo-600"></i>
            Admin Controller Central
        </h1>
        <p class="text-gray-500 mt-1">Securely manage and audit all business accounts. User ID: <span id="user-id" class="font-mono text-xs bg-gray-200 px-2 py-0.5 rounded-md">Authenticating...</span></p>
        <hr class="mt-4 border-indigo-100">
    </header>

    <!-- Dashboard Summary & Controls -->
    <main class="space-y-8">
        
        <!-- Summary Cards -->
        <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Card placeholders -->
        </div>

        <!-- Controls and Calendar Button -->
        <div class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-lg shadow-md border border-gray-100">
            <!-- Search Input -->
            <div class="relative w-full md:w-1/3">
                <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" onkeyup="filterBusinesses()" placeholder="Search by Business Name..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Filter Dropdown -->
            <div class="flex items-center space-x-3">
                <span class="text-gray-600">Status:</span>
                <select id="status-filter" onchange="filterBusinesses()" class="py-2 px-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="All">All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Expiring Soon">Expiring Soon</option>
                    <option value="Suspended">Suspended</option>
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 w-full md:w-auto justify-end">
                <button onclick="toggleCalendarModal(true)" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    <i data-lucide="calendar" class="w-5 h-5 mr-2"></i>
                    Calendar
                </button>
                <button onclick="openFormModal('add')" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Add New Business
                </button>
            </div>
        </div>

        <!-- Business Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 table-container">
            <table class="min-w-full divide-y divide-gray-200 data-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th onclick="sortTable('name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150 rounded-tl-xl">Business Name <i data-lucide="arrow-down-up" class="inline w-3 h-3 ml-1"></i></th>
                        <th onclick="sortTable('email')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150">Email</th>
                        <th onclick="sortTable('contact')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150">Contact Person</th>
                        <th onclick="sortTable('dateAdded')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150">Date Added</th>
                        <th onclick="sortTable('activationEndDate')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150">End Date</th>
                        <th onclick="sortTable('status')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="business-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
            <div id="no-data-message" class="text-center py-10 text-gray-500 hidden">
                No businesses match your current filter.
            </div>
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="flex justify-between items-center mt-4">
            <p id="pagination-info" class="text-sm text-gray-600"></p>
            <div class="flex space-x-2">
                <button id="prev-page" onclick="changePage(currentPage - 1)" class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 disabled:opacity-50" disabled>Previous</button>
                <button id="next-page" onclick="changePage(currentPage + 1)" class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
        
    </main>

    <!-- Full-Screen Modal for Add/Edit Business -->
    <div id="form-modal" class="fixed inset-0 hidden items-center justify-center p-4 calendar-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Business</h3>
                <button onclick="toggleFormModal(false)" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="business-form" class="p-6 space-y-4" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="form-row-index">
                <input type="hidden" id="form-action-type">
                
                <!-- Business Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Business Name</label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Contact -->
                <div>
                    <label for="contact" class="block text-sm font-medium text-gray-700">Contact Person</label>
                    <input type="text" id="contact" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Date Added (Read-only on Edit) -->
                <div>
                    <label for="dateAdded" class="block text-sm font-medium text-gray-700">Date Added</label>
                    <input type="date" id="dateAdded" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100">
                </div>

                <!-- Activation End Date -->
                <div>
                    <label for="activationEndDate" class="block text-sm font-medium text-gray-700">Activation End Date</label>
                    <input type="date" id="activationEndDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Form Actions -->
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="toggleFormModal(false)" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                    <button type="submit" id="form-submit-btn" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">Save Business</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Full-Screen Modal for Calendar View -->
    <div id="calendar-modal" class="fixed inset-0 hidden items-center justify-center p-4 calendar-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden transform transition-all">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-800">Business Timeline Calendar</h3>
                <button onclick="toggleCalendarModal(false)" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="calendar-container">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeCalendarMonth(-1)" class="px-3 py-1 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <h4 id="calendar-month-year" class="text-lg font-semibold text-gray-700"></h4>
                        <button onclick="changeCalendarMonth(1)" class="px-3 py-1 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center font-medium text-sm text-gray-500 mb-2">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar days go here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Logic -->
    <script type="module">
        // Initialize Lucide Icons
        lucide.createIcons();

        // --- FIREBASE AND API SETUP ---
        
        // The Web App URL for the deployed Google Apps Script.
        const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbwVZ_5GCA68OtJQzrKeKquzo_DQ8QiBi1C12yY92BM7yNVf4dLGqbzEdMv2ApFjUMlFVw/exec"; 

        // Firebase Setup (for user authentication and security rules)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state for Firebase and data
        let auth;
        let db;
        let userId = 'admin-guest'; // Default if auth fails
        let allBusinesses = [];
        let filteredBusinesses = [];
        let sortBy = 'name';
        let sortDirection = 'asc';
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentCalendarDate = new Date();

        // Canvas Environment Globals
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                // If the SHEETS_API_URL is the default placeholder, show a setup warning
                if (SHEETS_API_URL.includes("AKfycbwVZ_5GCA68OtJQzrKeKquzo_DQ8QiBi1C12yY92BM7yNVf4dLGqbzEdMv2ApFjUMlFVw")) {
                     // Note: Since the user provided this exact URL, we skip the setup warning but keep the check logic structure.
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                
                document.getElementById('user-id').textContent = userId;
                
                // Once authenticated, load data
                await loadBusinesses();

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                showToast("Auth Failed", "Could not sign in securely. Running as guest.", "error");
            }
        }

        // --- API CALL HANDLER ---

        /**
         * Securely makes requests to the deployed Google Apps Script API.
         * Implements exponential backoff for resilience.
         * @param {string} action - The action to perform (e.g., 'read', 'add', 'update').
         * @param {object} [data={}] - Payload for POST requests.
         * @param {string} [method='POST'] - HTTP method. Sheets API uses POST for all data ops.
         * @returns {Promise<object>} - The parsed JSON response from the Apps Script.
         */
        async function fetchSheetData(action, data = {}, method = 'POST') {
            const url = `${SHEETS_API_URL}?action=${action}`;
            const maxRetries = 3;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const payload = { ...data, userId }; // Always include userId for admin check
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'text/plain' }, // Must use text/plain for Apps Script to parse JSON payload
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'error') {
                        throw new Error(`API Error: ${result.message}`);
                    }
                    
                    return result;

                } catch (error) {
                    // Log error but suppress logging retries to console for cleaner output
                    if (i === maxRetries - 1) {
                         console.error(`Operation failed after ${maxRetries} attempts for action ${action}.`, error);
                         throw new Error(`Operation failed after ${maxRetries} attempts. Details: ${error.message}`);
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- DATA MANAGEMENT ---

        /**
         * Loads all business data from the Google Sheet via the Apps Script API.
         */
        async function loadBusinesses() {
            try {
                showToast("Loading Data", "Fetching business records...", "info", 1500);
                const result = await fetchSheetData('read', {}, 'POST'); // Use POST to read as it's more reliable with Apps Script permissions
                
                allBusinesses = result.data.map(processBusinessStatus);
                filterBusinesses();
                showToast("Success", `${allBusinesses.length} records loaded.`, "success");
            } catch (error) {
                console.error("Error loading businesses:", error);
                showToast("Load Failed", error.message, "error");
            }
        }

        /**
         * Applies the correct computed status ('Active', 'Suspended', 'Expiring Soon').
         */
        function processBusinessStatus(business) {
            const today = new Date();
            // Handle date parsing safely (especially for dates coming from Apps Script)
            const endDate = new Date(business.activationEndDate);

            // Check if date parsing failed (e.g., 'Invalid Date')
            if (isNaN(endDate)) {
                console.warn(`Invalid activationEndDate for business ${business.name}: ${business.activationEndDate}`);
                business.computedStatus = 'Suspended';
                return business;
            }

            const diffTime = endDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Status from sheet (Column F) takes precedence if manually set to 'Suspended'
            if (business.status === 'Suspended') {
                business.computedStatus = 'Suspended';
            } else if (diffDays <= 30 && diffDays > 0) {
                business.computedStatus = 'Expiring Soon';
            } else if (diffDays <= 0) {
                 business.computedStatus = 'Suspended'; // Automatically treat expired accounts as Suspended
            } else {
                business.computedStatus = 'Active';
            }
            return business;
        }

        // --- UI & RENDERING ---

        /**
         * Filters, sorts, and paginates the business list.
         */
        function filterBusinesses() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            let data = allBusinesses.filter(business => {
                const nameMatch = business.name.toLowerCase().includes(searchText);
                const statusMatch = statusFilter === 'All' || business.computedStatus === statusFilter;
                return nameMatch && statusMatch;
            });

            // 1. Sort
            data.sort((a, b) => {
                const valA = a[sortBy] || '';
                const valB = b[sortBy] || '';

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            filteredBusinesses = data;
            currentPage = 1; // Reset to first page after filter/sort
            renderDashboard();
        }

        /**
         * Changes the current page for pagination.
         */
        function changePage(page) {
            const totalPages = Math.ceil(filteredBusinesses.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                updatePaginationControls();
            }
        }

        /**
         * Sorts the table by the given key.
         */
        function sortTable(key) {
            if (sortBy === key) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortBy = key;
                sortDirection = 'asc';
            }
            filterBusinesses();
        }

        /**
         * Renders the main dashboard components (Summary, Table, Calendar).
         */
        function renderDashboard() {
            renderSummaryCards();
            renderTable();
            updatePaginationControls();
            renderCalendar(); // Re-render calendar to reflect latest data
        }

        /**
         * Renders the summary cards at the top of the dashboard.
         */
        function renderSummaryCards() {
            const counts = allBusinesses.reduce((acc, business) => {
                acc[business.computedStatus] = (acc[business.computedStatus] || 0) + 1;
                return acc;
            }, { 'Active': 0, 'Expiring Soon': 0, 'Suspended': 0 });

            const total = allBusinesses.length;

            const cards = [
                { title: "Total Businesses", icon: "bar-chart-2", value: total, color: "text-indigo-600", bg: "bg-indigo-50" },
                { title: "Active", icon: "check-circle", value: counts['Active'], color: "text-green-600", bg: "bg-green-50" },
                { title: "Expiring Soon", icon: "alert-triangle", value: counts['Expiring Soon'], color: "text-amber-600", bg: "bg-amber-50" },
                { title: "Suspended", icon: "x-circle", value: counts['Suspended'], color: "text-red-600", bg: "bg-red-50" }
            ];

            const html = cards.map(card => `
                <div class="p-5 bg-white rounded-xl shadow-md border border-gray-100">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full ${card.bg}">
                            <i data-lucide="${card.icon}" class="w-6 h-6 ${card.color}"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-800">${card.value}</h2>
                            <p class="text-sm text-gray-500">${card.title}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('summary-cards').innerHTML = html;
            // Re-render Lucide icons after injection
            lucide.createIcons();
        }

        /**
         * Renders the current page of the business data table.
         */
        function renderTable() {
            const tableBody = document.getElementById('business-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const businessesToShow = filteredBusinesses.slice(start, end);

            if (businessesToShow.length === 0 && filteredBusinesses.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.textContent = "No businesses found.";
                noDataMessage.classList.remove('hidden');
                return;
            } else if (businessesToShow.length === 0) {
                 tableBody.innerHTML = '';
                 noDataMessage.textContent = "No businesses match your current filter.";
                 noDataMessage.classList.remove('hidden');
                 return;
            } else {
                 noDataMessage.classList.add('hidden');
            }


            const html = businessesToShow.map(business => {
                const badgeClass = {
                    'Active': 'active-status',
                    'Expiring Soon': 'expiring-status',
                    'Suspended': 'suspended-status',
                }[business.computedStatus] || 'text-gray-500 bg-gray-100';

                const actionButton = business.computedStatus !== 'Suspended' 
                    ? `<button onclick="updateStatusClick(${business.rowIndex}, 'Suspended', '${business.name}')" class="text-red-500 hover:text-red-700 transition duration-150 p-1" title="Suspend"><i data-lucide="shield-off" class="w-5 h-5"></i></button>`
                    : `<button onclick="updateStatusClick(${business.rowIndex}, 'Active', '${business.name}')" class="text-green-500 hover:text-green-700 transition duration-150 p-1" title="Reactivate"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>`;

                return `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${business.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${business.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${business.contact}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${business.dateAdded}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${business.activationEndDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${badgeClass}">
                                ${business.computedStatus}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex space-x-2">
                            <button onclick="openFormModal('edit', ${business.rowIndex})" class="text-indigo-600 hover:text-indigo-900 transition duration-150 p-1" title="Edit"><i data-lucide="edit" class="w-5 h-5"></i></button>
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = html;
            // Re-render Lucide icons after injection
            lucide.createIcons();
        }

        /**
         * Updates pagination information and button states.
         */
        function updatePaginationControls() {
            const totalItems = filteredBusinesses.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            document.getElementById('pagination-info').textContent = 
                totalItems > 0 
                ? `Showing ${startItem} to ${endItem} of ${totalItems} results (Page ${currentPage} of ${totalPages})`
                : `No results found.`;

            document.getElementById('prev-page').disabled = currentPage === 1 || totalPages === 0;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        // --- CALENDAR VIEW ---

        /**
         * Toggles the calendar modal visibility.
         */
        function toggleCalendarModal(show) {
            const modal = document.getElementById('calendar-modal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                renderCalendar();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        /**
         * Changes the displayed month in the calendar.
         */
        window.changeCalendarMonth = function(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        /**
         * Renders the calendar grid.
         */
        function renderCalendar() {
            const container = document.getElementById('calendar-grid');
            const monthYearText = document.getElementById('calendar-month-year');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            monthYearText.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Find the first day of the month and the number of days
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
            
            let html = '';

            // 1. Padding (empty cells before the 1st)
            for (let i = 0; i < startDay; i++) {
                html += '<div class="h-20 p-1"></div>';
            }

            // 2. Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                // Ensure date components are zero-padded for accurate matching
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Events for this day
                const events = allBusinesses.filter(b => 
                    b.dateAdded === dateKey || b.activationEndDate === dateKey
                );

                const hasAdded = events.some(e => e.dateAdded === dateKey);
                const hasEnd = events.some(e => e.activationEndDate === dateKey);
                
                const dayClasses = `h-20 p-2 text-sm border rounded-lg transition duration-100 relative ${
                    hasAdded || hasEnd ? 'bg-indigo-50 border-indigo-200 shadow-md' : 'bg-white border-gray-200 hover:bg-gray-50'
                }`;

                html += `
                    <div class="${dayClasses}">
                        <div class="text-right font-bold text-gray-800">${day}</div>
                        <div class="space-y-0.5 mt-1 overflow-hidden">
                            ${hasAdded ? '<span class="block px-1 bg-green-200 text-green-800 rounded-md text-xs truncate" title="Business Added">Added</span>' : ''}
                            ${hasEnd ? '<span class="block px-1 bg-red-200 text-red-800 rounded-md text-xs truncate" title="Activation Ends">Ends</span>' : ''}
                        </div>
                        ${events.length > 2 ? `<div class="text-xs text-gray-500 mt-1">+${events.length - 2} events</div>` : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // --- CRUD OPERATIONS ---

        /**
         * Toggles the add/edit business modal.
         */
        function toggleFormModal(show) {
            const modal = document.getElementById('form-modal');
            const form = document.getElementById('business-form');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                // Auto-focus the first input
                document.getElementById('name').focus();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                form.reset(); // Clear form on close
            }
        }

        /**
         * Opens the modal configured for 'add' or 'edit'.
         */
        window.openFormModal = function(action, rowIndex) {
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('form-submit-btn');
            const dateAddedInput = document.getElementById('dateAdded');
            
            document.getElementById('form-action-type').value = action;
            document.getElementById('form-row-index').value = rowIndex || '';
            
            if (action === 'add') {
                title.textContent = "Add New Business";
                btn.textContent = "Create Business";
                // Set default date to today for new record
                dateAddedInput.value = new Date().toISOString().split('T')[0];
                dateAddedInput.disabled = false;
            } else {
                title.textContent = "Edit Business";
                btn.textContent = "Update Business";
                const business = allBusinesses.find(b => b.rowIndex === rowIndex);
                if (business) {
                    document.getElementById('name').value = business.name;
                    document.getElementById('email').value = business.email;
                    document.getElementById('contact').value = business.contact;
                    dateAddedInput.value = business.dateAdded;
                    dateAddedInput.disabled = true; // Date added should not be editable
                    document.getElementById('activationEndDate').value = business.activationEndDate;
                }
            }
            toggleFormModal(true);
        }

        /**
         * Handles form submission for adding or editing a business.
         */
        window.handleFormSubmit = async function(event) {
            event.preventDefault();
            const action = document.getElementById('form-action-type').value;
            const rowIndex = document.getElementById('form-row-index').value;
            const status = 'Active'; // New businesses are always 'Active'

            const businessData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                contact: document.getElementById('contact').value,
                dateAdded: document.getElementById('dateAdded').value, // Now explicitly read date added
                activationEndDate: document.getElementById('activationEndDate').value,
                status: status,
                rowIndex: rowIndex ? parseInt(rowIndex) : null
            };

            toggleFormModal(false); // Close modal immediately

            try {
                if (action === 'add') {
                    await fetchSheetData('add', businessData);
                    showToast("Success", `Business '${businessData.name}' created.`, "success");
                } else if (action === 'edit') {
                    await fetchSheetData('update', businessData);
                    showToast("Success", `Business '${businessData.name}' updated.`, "success");
                }
                
                await loadBusinesses(); // Reload data to get updated rowIndex or changes

            } catch (error) {
                console.error(`Error performing ${action}:`, error);
                showToast("Operation Failed", error.message, "error");
            }
        }

        /**
         * Handles the click event to change a business status (Suspend/Reactivate).
         */
        window.updateStatusClick = async function(rowIndex, newStatus, name) {
            const verb = newStatus === 'Suspended' ? 'Suspending' : 'Reactivating';
            showToast("Processing", `${verb} business '${name}'...`, "info", 3000);

            try {
                // Note: The Apps Script updates the 'Status' column directly.
                await fetchSheetData('updateStatus', { rowIndex, status: newStatus }); 
                showToast("Success", `Business '${name}' is now ${newStatus}.`, "success");
                await loadBusinesses(); // Reload data
            } catch (error) {
                console.error(`Error updating status for ${name}:`, error);
                showToast("Status Update Failed", error.message, "error");
            }
        }

        // --- UTILITY: TOASTS ---

        /**
         * Displays a temporary notification (Toast).
         * @param {string} title - Main title of the toast.
         * @param {string} message - Detailed message.
         * @param {string} type - 'success', 'error', or 'info'.
         * @param {number} duration - Time in ms before hiding.
         */
        function showToast(title, message, type, duration = 5000) {
            const container = document.getElementById('toast-container');
            const id = Date.now();
            
            let colorClass, iconHtml;

            switch (type) {
                case 'success':
                    colorClass = 'bg-green-500 border-green-700';
                    iconHtml = '<i data-lucide="check-circle" class="w-6 h-6 text-white"></i>';
                    break;
                case 'error':
                    colorClass = 'bg-red-500 border-red-700';
                    iconHtml = '<i data-lucide="x-octagon" class="w-6 h-6 text-white"></i>';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-indigo-500 border-indigo-700';
                    iconHtml = '<i data-lucide="info" class="w-6 h-6 text-white"></i>';
                    break;
            }

            const toastHtml = `
                <div id="toast-${id}" class="flex items-center w-full max-w-xs p-4 rounded-xl shadow-lg ${colorClass} text-white transition-all transform opacity-0 translate-x-full">
                    <div class="flex-shrink-0">${iconHtml}</div>
                    <div class="ml-3 text-sm font-medium">
                        <p class="font-bold">${title}</p>
                        <p>${message}</p>
                    </div>
                    <button type="button" onclick="document.getElementById('toast-${id}').remove()" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-white hover:text-gray-200 p-1.5 rounded-lg focus:ring-2 focus:ring-gray-300">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);
            lucide.createIcons();
            const toastElement = document.getElementById(`toast-${id}`);

            // Animate in
            setTimeout(() => {
                toastElement.classList.remove('opacity-0', 'translate-x-full');
                toastElement.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toastElement.classList.remove('opacity-100', 'translate-x-0');
                toastElement.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toastElement.remove(), 500);
            }, duration);
        }

        // --- INITIALIZATION ---
        
        window.onload = function() {
            initFirebase();
        };

        // Expose functions globally for HTML event handlers
        window.filterBusinesses = filterBusinesses;
        window.sortTable = sortTable;
        window.changePage = changePage;

    </script>
</body>
</html>
