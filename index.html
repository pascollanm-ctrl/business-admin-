<!DOCTYPE html>
<html lang="en" class=""> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasco Creation – Business Automation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for better readability and a modern feel */
        :root {
            --primary: #3b82f6; /* Blue-500 */
            --primary-dark: #2563eb; /* Blue-600 */
        }
        /* --- Base Light Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            transition: background-color 0.3s, color 0.3s;
        }
        .container-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Custom row colors for light theme */
        .table-row-green { background-color: #d1fae5; } /* Active */
        .table-row-orange { background-color: #fef3c7; } /* Expiring Soon */
        .table-row-red { background-color: #fee2e2; } /* Expired */
        .table-row-gray { background-color: #e5e7eb; } /* Suspended */
        /* --- Dark Theme Styles --- */
        .dark body {
            background-color: #111827; /* Gray-900 */
            color: #e5e7eb; /* Gray-200 */
        }
        /* Update backgrounds for dark mode */
        .dark .bg-white { background-color: #1f2937; } /* Gray-800 for cards, nav, table container, modal */
        .dark .bg-gray-50 { background-color: #374151; } /* Table header background */
        .dark .bg-gray-100 { background-color: #374151; } /* Suspended row */
        
        /* Update text colors for dark mode (Ensuring no faded text) */
        .dark .text-gray-800, .dark .text-gray-900 { color: #f9fafb; } /* Gray-50 */
        .dark .text-gray-700 { color: #d1d5db; } /* Gray-300 */
        .dark .text-gray-500, .dark .text-gray-600 { color: #9ca3af; } /* Gray-400 */
        
        /* Update borders */
        .dark .border-gray-200 { border-color: #4b5563; }
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .divide-gray-200 { border-color: #4b5563; }
        
        /* Update table row colors for dark theme */
        .dark .table-row-green { background-color: #064e3b; } /* Active (Emerald 900) */
        .dark .table-row-orange { background-color: #78350f; } /* Expiring Soon (Amber 900) */
        .dark .table-row-red { background-color: #7f1d1d; } /* Expired (Red 900) */
        .dark .table-row-gray { background-color: #374151; } /* Suspended (Gray-700) */
        
        /* Update table hover */
        .dark .hover\:bg-gray-50:hover { background-color: #374151; }
        
        /* Update inputs */
        .dark input, .dark select {
            background-color: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        .dark input::placeholder { color: #9ca3af; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: var(--primary-dark); }
        /* Ensure smooth view transition */
        .view {
            transition: opacity 0.3s ease-in-out;
        }
        /* Responsive table cell styling for mobile */
        @media (max-width: 768px) {
            .table-cell-mobile-label::before {
                content: attr(data-label);
                font-weight: 600;
                display: block;
                margin-bottom: 4px;
                color: #4b5563; /* Gray-600 */
            }
            .dark .table-cell-mobile-label::before {
                color: #9ca3af; /* Gray-400 */
            }
            .table-responsive thead { display: none; }
            .table-responsive tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .dark .table-responsive tr {
                border-color: #374151;
            }
            .table-responsive td {
                display: block;
                text-align: right;
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #e5e7eb;
            }
            .dark .table-responsive td {
                border-bottom-color: #374151;
            }
            .table-responsive td:last-child { border-bottom: none; }
            .table-responsive td:first-child { background-color: #e5e7eb; font-weight: 700; text-align: left; }
            .dark .table-responsive td:first-child { background-color: #374151; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] transition-opacity duration-300 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message" class="mt-3 text-white text-lg">Connecting to Google Sheet API...</span>
        </div>
    </div>
    <div id="login-view" class="view hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 p-8 rounded-xl container-shadow">
            <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-50 mb-6 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 text-blue-500 mr-2"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z"/><path d="M18.8 8c.2-.7.4-1.4.4-2s-.2-1.4-.4-2M5.2 8c-.2-.7-.4-1.4-.4-2s.2-1.4.4-2"/><path d="M14.5 17.5l-3-3"/><path d="M10.5 17.5l3-3"/><path d="M8.5 12h7"/></svg>
                Pasco Creation Login
            </h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-8">Access the Business Automation Dashboard</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="pascollanm@gmail.com">
                </div>
                
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="••••••••">
                        <button type="button" id="password-toggle" onclick="showPasswordToggle()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
                            <svg id="toggle-icon-eye" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden p-3 bg-red-100 rounded-lg"></div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Login to Dashboard
                </button>
            </form>
        </div>
    </div>
    <div id="dashboard-view" class="view hidden min-h-screen">
        <nav class="bg-white dark:bg-gray-800 container-shadow p-4 flex justify-between items-center sticky top-0 z-30">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-50 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-500 mr-2 hidden sm:block"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z"/><path d="M18.8 8c.2-.7.4-1.4.4-2s-.2-1.4-.4-2M5.2 8c-.2-.7-.4-1.4-.4-2s.2-1.4.4-2"/><path d="M14.5 17.5l-3-3"/><path d="M10.5 17.5l3-3"/><path d="M8.5 12h7"/></svg>
                Pasco Creation – Business Automation Dashboard
            </h1>
            
            <div class="relative">
                <button id="menu-button" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-expanded="false" aria-haspopup="true">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
                
                <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 hidden origin-top-right focus:outline-none z-20">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="menu-button">
                        <button id="theme-toggle" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 hover:text-gray-900 transition" role="menuitem">
                            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
                            <span id="theme-text">Change Theme</span>
                        </button>
                        <button id="logout-button" class="w-full text-left flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900 dark:hover:text-red-300 hover:text-red-700 transition" role="menuitem">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                            Log Out
                        </button>
                    </div>
                </div>
            </div>
            </nav>
        <main class="p-4 md:p-8">
            <div class="space-y-8">
                <div id="summary-cards" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>
                <div class="flex flex-col md:flex-row gap-4 justify-between items-stretch">
                    <input type="text" id="search-input" placeholder="Search by Business Name..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <select id="status-filter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="All">Filter by Status: All</option>
                        <option value="Active">Active</option>
                        <option value="Suspended">Suspended</option>
                        <option value="Expiring Soon">Expiring Soon</option>
                        <option value="Expired">Expired</option>
                    </select>
                    <button id="add-business-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                        Add Business
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl container-shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600 table-fixed table-responsive">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Business Name</th>
                                <th class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Owner</th>
                                <th class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contact</th>
                                <th class="w-auto px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Dates</th>
                                <th class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="w-1/6 px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="businesses-table-body" class="divide-y divide-gray-200 dark:divide-gray-600">
                            </tbody>
                    </table>
                    <p id="no-businesses" class="text-center text-gray-500 dark:text-gray-400 p-8 hidden">No businesses found matching the current criteria.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl container-shadow">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-50 mb-4">Business Status Overview</h2>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div class="hidden md:block"></div>
                </div>
            </div>
        </main>
    </div>
    <div id="business-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-40 items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-lg container-shadow" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-semibold text-gray-800 dark:text-gray-50">Add New Business</h2>
                <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form id="business-form" class="p-6 space-y-4">
                <input type="hidden" id="business-id">
                <div>
                    <label for="business-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Business Name</label>
                    <input type="text" id="business-name" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="owner" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Owner Name</label>
                    <input type="text" id="owner" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="contact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contact Email/Phone</label>
                    <input type="text" id="contact" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="start-date" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Expiry)</label>
                        <input type="date" id="end-date" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Initial Status</label>
                    <select id="status" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Active">Active</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>
                <button type="submit" id="modal-submit-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-200">
                    Save Business
                </button>
            </form>
        </div>
    </div>
    
    <div id="custom-alert-container" class="fixed top-5 right-5 z-[100] w-full max-w-sm"></div>
    <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 items-center justify-center p-4" onclick="closeModal(event, 'confirm-delete-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-sm container-shadow" onclick="event.stopPropagation()">
            <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-50 mt-4">Delete Business?</h3>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Are you sure you want to delete this business? This action cannot be undone.</p>
            </div>
            <div class="grid grid-cols-2 gap-4 p-6 bg-gray-50 dark:bg-gray-700 rounded-b-xl">
                <button id="confirm-delete-cancel" class="w-full bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        // ----------------------------------------------------------------------
        // --- 1. CONFIGURATION & INITIALIZATION ---
        // ----------------------------------------------------------------------
        // !!! GOOGLE APPS SCRIPT API URL (Your latest URL) !!!
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwBJheYkpzSv0rCxm60k3-Q5GMbWKkwybwi2LPvgJRNE5TWtOpqrL76e_ykeVY-_lzfew/exec'; 

        // !!! HARDCODED ADMIN CREDENTIALS (FRONTEND ONLY) !!!
        const JS_ADMIN_EMAIL = 'pascollanm@gmail.com';
        // !!! PASSWORD !!! 
        const JS_ADMIN_PASSWORD = 'Pasco@5861'; 
        
        let allBusinesses = []; 
        let chartInstance = null;

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const businessesTableBody = document.getElementById('businesses-table-body');
        const noBusinessesMessage = document.getElementById('no-businesses');
        
        // --- Menu & Theme Elements ---
        const menuButton = document.getElementById('menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        const logoutButton = document.getElementById('logout-button'); 
        
        // --- Confirm Delete Modal Elements ---
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const confirmDeleteCancelBtn = document.getElementById('confirm-delete-cancel');
        
        const businessModal = document.getElementById('business-modal');
        const businessForm = document.getElementById('business-form');
        const modalTitle = document.getElementById('modal-title');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');

        // Icons for Theme Toggle
        const sunIcon = `<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707M17.657 6.343l.707-.707M6.343 17.657l-.707.707M8 12a4 4 0 1 1 8 0 4 4 0 0 1-8 0z"/>`;
        const moonIcon = `<path d="M12 3a6 6 0 0 0 9 6 6 6 0 0 1-9-6Z"/><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707M17.657 6.343l.707-.707M6.343 17.657l-.707.707"/>`;
        
        // --- 2. THEME MANAGEMENT (UNCHANGED) ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.innerHTML = sunIcon;
                themeText.textContent = 'Light Mode';
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.innerHTML = moonIcon;
                themeText.textContent = 'Dark Mode';
            }
            localStorage.setItem('theme', theme); 
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            userMenuDropdown.classList.add('hidden'); 
        }
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
        }
        initializeTheme();

        // --- 3. PASSWORD VISIBILITY TOGGLE (UNCHANGED) ---
        window.showPasswordToggle = function() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggle-icon-eye');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.innerHTML = `<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6 12c.57-1.78 2.5-4.88 5-6.36"/><path d="M16.17 16.17a2 2 0 0 1-2.26 1.76"/><path d="M2 2l20 20"/>`;
            } else {
                passwordInput.type = 'password';
                toggleIcon.innerHTML = `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>`;
            }
        }
        
        // ----------------------------------------------------------------------
        // --- 4. DATA COMMUNICATION & VIEW MANAGEMENT ---
        // ----------------------------------------------------------------------
        function showLoading(message = "Connecting...") { 
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function switchView(isAuthenticated) {
            if (isAuthenticated) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                fetchBusinesses(); // Start fetching data
                localStorage.setItem('isAuthenticated', 'true');
            } else {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                localStorage.removeItem('isAuthenticated');
            }
            hideLoading();
        }
        
        // --- INITIAL AUTH CHECK ---
        window.addEventListener('load', () => {
            const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
            if (isAuthenticated) {
                 showLoading("Loading Dashboard...");
                 // Give a moment for the loading screen to show
                 setTimeout(() => switchView(true), 500); 
            } else {
                // If not authenticated, show login immediately
                switchView(false);
            }
        });

        // 4.1 Login Handler (Hardcoded Check)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading("Logging in...");
            loginError.classList.add('hidden');
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (email === JS_ADMIN_EMAIL && password === JS_ADMIN_PASSWORD) {
                setTimeout(() => {
                    switchView(true);
                    showCustomAlert('Login Successful!', 'success');
                }, 1000);
            } else {
                hideLoading();
                loginError.textContent = 'Invalid email or password.';
                loginError.classList.remove('hidden');
                showCustomAlert('Login Failed!', 'error');
            }
        });

        // 4.2 Logout Handler (in menu)
        logoutButton.addEventListener('click', async () => {
            userMenuDropdown.classList.add('hidden'); 
            showLoading("Logging out...");
            setTimeout(() => {
                allBusinesses = [];
                renderBusinesses(allBusinesses);
                updateSummary(allBusinesses);
                switchView(false);
                showCustomAlert('Logged out successfully.', 'info');
            }, 1000);
        });

        // --- GOOGLE SHEET API CALLS (CORE) ---

        /**
         * Fetches all business data from the Google Apps Script (GAS) API.
         */
        async function fetchBusinesses() {
            showLoading("Fetching business data from Google Sheet...");
            try {
                const response = await fetch(GAS_API_URL);
                const result = await response.json();

                if (result.success) {
                    allBusinesses = result.data.map(business => ({
                        ...business,
                        id: business.id ? business.id.toString() : null 
                    }));
                    processAndRenderData(allBusinesses);
                } else {
                    console.error("Failed to fetch data:", result.error);
                    showCustomAlert(`Error fetching data: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error("Network or API error:", error);
                showCustomAlert(`A network error occurred while fetching data.`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        /**
         * Sends a POST request to the GAS API to add/update/delete data.
         */
        async function manageBusinessInSheet(action, data, id) {
            showLoading(`${action.charAt(0).toUpperCase() + action.slice(1)} business...`);
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data, id })
                });
                const result = await response.json();

                if (result.success) {
                    showCustomAlert(`Business ${action}ed successfully!`, 'success');
                    // Re-fetch all data to ensure the dashboard is in sync
                    fetchBusinesses(); 
                    return true;
                } else {
                    console.error(`Failed to ${action} business:`, result.error);
                    showCustomAlert(`Error: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("Network or API error:", error);
                showCustomAlert(`A network error occurred during ${action}.`, 'error');
                return false;
            } finally {
                hideLoading();
            }
        }
        
        // ----------------------------------------------------------------------
        // --- 5. DATA PROCESSING & RENDERING (UNCHANGED) ---
        // ----------------------------------------------------------------------
        
        function processAndRenderData(businesses) {
            businesses = businesses.map(business => ({
                ...business,
                Status: calculateStatus(business.EndDate, business.Status)
            }));
            
            allBusinesses = businesses;
            updateSummary(allBusinesses);
            // Apply current filters/search before rendering
            applyFiltersAndSearch(); 
            updateChart(allBusinesses);
        }
        
        function calculateStatus(endDateStr, currentStatus) {
            if (currentStatus === 'Suspended') {
                return 'Suspended';
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            const oneDay = 24 * 60 * 60 * 1000; 
            const diffDays = Math.round((endDate.getTime() - today.getTime()) / oneDay);

            if (diffDays < 0) {
                return 'Expired';
            } else if (diffDays <= 30) { 
                return 'Expiring Soon';
            } else {
                return 'Active';
            }
        }

        // --- SUMMARY CARD & CHART UPDATE (UNCHANGED) ---
        function updateSummary(businesses) {
            const activeCount = businesses.filter(b => b.Status === 'Active').length;
            const expiringCount = businesses.filter(b => b.Status === 'Expiring Soon').length;
            const expiredCount = businesses.filter(b => b.Status === 'Expired').length;
            const suspendedCount = businesses.filter(b => b.Status === 'Suspended').length;
            const totalCount = businesses.length;
            
            const cards = [
                { title: "Total Businesses", value: totalCount, icon: "package", color: "blue" },
                { title: "Active Contracts", value: activeCount, icon: "check-circle", color: "green" },
                { title: "Expiring Soon", value: expiringCount, icon: "alert-triangle", color: "amber" },
                { title: "Expired/Suspended", value: expiredCount + suspendedCount, icon: "x-octagon", color: "red" }
            ];

            const summaryCardsDiv = document.getElementById('summary-cards');
            summaryCardsDiv.innerHTML = cards.map(card => `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl container-shadow flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${card.title}</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-50 mt-1">${card.value}</p>
                    </div>
                    <div class="p-3 rounded-full bg-${card.color}-100 dark:bg-${card.color}-900/50 text-${card.color}-600 dark:text-${card.color}-400">
                        <svg class="w-6 h-6" data-lucide="${card.icon}"></svg>
                    </div>
                </div>
            `).join('');
            // Re-render lucide icons after updating HTML
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function updateChart(businesses) {
            const statusCounts = {
                'Active': businesses.filter(b => b.Status === 'Active').length,
                'Expiring Soon': businesses.filter(b => b.Status === 'Expiring Soon').length,
                'Expired': businesses.filter(b => b.Status === 'Expired').length,
                'Suspended': businesses.filter(b => b.Status === 'Suspended').length,
            };

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const backgroundColors = [
                'rgb(59, 130, 246)',  // Blue (Active)
                'rgb(245, 158, 11)',  // Amber (Expiring Soon)
                'rgb(239, 68, 68)',   // Red (Expired)
                'rgb(107, 114, 128)'  // Gray (Suspended)
            ];

            const ctx = document.getElementById('status-chart');

            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.data.datasets[0].backgroundColor = backgroundColors;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- TABLE RENDERING (UNCHANGED) ---
        function renderBusinesses(businessesToDisplay) {
            businessesTableBody.innerHTML = '';
            
            if (businessesToDisplay.length === 0) {
                noBusinessesMessage.classList.remove('hidden');
                return;
            }
            noBusinessesMessage.classList.add('hidden');
            
            businessesToDisplay.forEach(business => {
                businessesTableBody.innerHTML += createBusinessRow(business);
            });

            // Re-render lucide icons for actions
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function createBusinessRow(business) {
            let rowClass;
            let statusBadge;

            switch (business.Status) {
                case 'Active':
                    rowClass = 'table-row-green';
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">Active</span>`;
                    break;
                case 'Expiring Soon':
                    rowClass = 'table-row-orange';
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800 dark:bg-amber-800 dark:text-amber-100">Expiring Soon</span>`;
                    break;
                case 'Expired':
                    rowClass = 'table-row-red';
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100">Expired</span>`;
                    break;
                case 'Suspended':
                    rowClass = 'table-row-gray';
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Suspended</span>`;
                    break;
                default:
                    rowClass = '';
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">${business.Status}</span>`;
            }

            return `
                <tr class="${rowClass} hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150">
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-50 table-cell-mobile-label" data-label="Business Name">${business.BusinessName}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 table-cell-mobile-label" data-label="Owner">${business.Owner}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 table-cell-mobile-label" data-label="Contact">${business.Contact}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 table-cell-mobile-label" data-label="Dates">
                        <div class="text-xs">Start: ${business.StartDate}</div>
                        <div class="text-xs font-semibold">End: ${business.EndDate}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap table-cell-mobile-label" data-label="Status">${statusBadge}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="handleEditClick('${business.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 transition duration-150 p-1 rounded-full hover:bg-blue-50 dark:hover:bg-gray-700" title="Edit">
                                <svg class="w-5 h-5" data-lucide="pencil"></svg>
                            </button>
                            <button onclick="handleDeleteClick('${business.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 transition duration-150 p-1 rounded-full hover:bg-red-50 dark:hover:bg-gray-700" title="Delete">
                                <svg class="w-5 h-5" data-lucide="trash-2"></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // --- FILTERING AND SEARCH (UNCHANGED) ---
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');

        searchInput.addEventListener('input', applyFiltersAndSearch);
        statusFilter.addEventListener('change', applyFiltersAndSearch);

        function applyFiltersAndSearch() {
            let filteredBusinesses = allBusinesses;
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;

            // 1. Apply Search Filter
            if (searchTerm) {
                filteredBusinesses = filteredBusinesses.filter(b =>
                    b.BusinessName.toLowerCase().includes(searchTerm) ||
                    b.Owner.toLowerCase().includes(searchTerm) ||
                    b.Contact.toLowerCase().includes(searchTerm)
                );
            }

            // 2. Apply Status Filter
            if (selectedStatus !== 'All') {
                filteredBusinesses = filteredBusinesses.filter(b => b.Status === selectedStatus);
            }

            renderBusinesses(filteredBusinesses);
        }

        // --- MODAL AND FORM LOGIC (UNCHANGED) ---

        // Attach event listener to the Add Business button
        document.getElementById('add-business-btn').addEventListener('click', () => {
            showModal('add');
        });

        function showModal(mode, business = {}) { 
            document.getElementById('business-id').value = business.id || '';
            document.getElementById('business-name').value = business.BusinessName || '';
            document.getElementById('owner').value = business.Owner || '';
            document.getElementById('contact').value = business.Contact || '';
            document.getElementById('start-date').value = business.StartDate || ''; 
            document.getElementById('end-date').value = business.EndDate || '';
            document.getElementById('status').value = business.Status || 'Active';
            
            modalTitle.textContent = mode === 'add' ? 'Add New Business' : 'Edit Business';
            modalSubmitBtn.textContent = mode === 'add' ? 'Save Business' : 'Update Business';

            businessModal.classList.remove('hidden');
            businessModal.classList.add('flex');
        }

        window.hideModal = function() { 
            businessModal.classList.add('hidden');
            businessModal.classList.remove('flex');
            businessForm.reset();
        }
        
        window.closeModal = function(event, modalId = 'business-modal') { 
            if (event.target.id === modalId) {
                if (modalId === 'business-modal') {
                    hideModal();
                } else if (modalId === 'confirm-delete-modal') {
                    confirmDeleteModal.classList.add('hidden');
                }
            }
        }

        // --- Form Submission Handler (Calls GAS API) ---
        businessForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('business-id').value;
            const mode = id ? 'update' : 'add';

            const data = {
                BusinessName: document.getElementById('business-name').value,
                Owner: document.getElementById('owner').value,
                Contact: document.getElementById('contact').value,
                StartDate: document.getElementById('start-date').value,
                EndDate: document.getElementById('end-date').value,
                Status: document.getElementById('status').value 
            };

            let result = false;
            if (mode === 'add') {
                result = await manageBusinessInSheet('add', data);
            } else { // update
                result = await manageBusinessInSheet('update', data, id);
            }

            if (result) {
                hideModal();
            }
        });

        // --- Action Handlers ---
        window.handleEditClick = function(id) { 
            const business = allBusinesses.find(b => b.id === id);
            if (business) {
                showModal('edit', business);
            }
        }

        let businessIdToDelete = null; 

        window.handleDeleteClick = function(id) { 
            businessIdToDelete = id;
            confirmDeleteModal.classList.remove('hidden');
            confirmDeleteModal.classList.add('flex');
        }
        
        confirmDeleteCancelBtn.addEventListener('click', () => {
            confirmDeleteModal.classList.add('hidden');
            businessIdToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (businessIdToDelete) {
                const result = await manageBusinessInSheet('delete', {}, businessIdToDelete);
                if (result) {
                    confirmDeleteModal.classList.add('hidden');
                }
            }
            businessIdToDelete = null;
        });

        // --- CUSTOM ALERT (UNCHANGED) ---
        function showCustomAlert(message, type = 'info') {
            const container = document.getElementById('custom-alert-container');
            const alert = document.createElement('div');
            
            const typeClasses = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };

            alert.className = `p-4 rounded-lg text-white shadow-lg mb-3 flex items-center ${typeClasses[type]} opacity-0 transition-opacity duration-300`;
            alert.innerHTML = `
                <svg class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' : ''}
                    ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' : ''}
                    ${type === 'info' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' : ''}
                </svg>
                <span>${message}</span>
            `;
            
            container.appendChild(alert);

            // Fade in
            setTimeout(() => alert.style.opacity = 1, 10);
            
            // Fade out and remove after 3 seconds
            setTimeout(() => {
                alert.style.opacity = 0;
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
        
        // --- MENU TOGGLE (UNCHANGED) ---
        menuButton.addEventListener('click', () => {
            const isExpanded = userMenuDropdown.classList.contains('hidden');
            if (isExpanded) {
                userMenuDropdown.classList.remove('hidden');
                menuButton.setAttribute('aria-expanded', 'true');
            } else {
                userMenuDropdown.classList.add('hidden');
                menuButton.setAttribute('aria-expanded', 'false');
            }
        });
        document.addEventListener('click', (event) => {
            if (!menuButton.contains(event.target) && !userMenuDropdown.contains(event.target)) {
                userMenuDropdown.classList.add('hidden');
                menuButton.setAttribute('aria-expanded', 'false');
            }
        });
        themeToggleBtn.addEventListener('click', toggleTheme); 

    </script>
</body>
</html>
